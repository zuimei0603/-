大数据量高并发访问时，经常会出现服务或接口面对暴涨的请求而变得不可用的情况，甚至引发连锁反应，导致整个系统崩溃。

此时需要使用限流技术，当请求达到一定的并发数或速率，就需要进行等待、排队、降级、拒绝服务等。漏桶和令牌桶是常用的两种算法。另外补充计数器算法和滑动窗口算法。

### 漏桶算法(Leaky Bucket)

#### 目的

控制数据注入到网络的速率，平滑网络上的突发流量。

#### 思路

请求先进入到漏桶里，漏桶以一定的速度出水（处理请求）。当请求过多，超过漏桶容量时，会直接拒绝服务。**能够强行限制数据的传输速率**。

![img](https://img-blog.csdn.net/20161109175847403?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

### 令牌桶算法（token bucket）

#### 目的

令牌桶算法能控制发送到网络上数据的数目，并且允许突发数据的发送。

#### 思路

令牌桶的容量是固定的，以恒定的速率产生令牌放入令牌桶。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌会不断增多，直到令牌桶填满。

当请求到来时，先从令牌桶取出令牌，然后再发送到网络上（进行请求处理）。如果没有令牌，则拒绝服务。

![img](https://img-blog.csdn.net/20161109175913747?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center)

#### 两种算法区别

- 令牌桶算法允许一定程度的突发流量。（假设桶内有100个token时，可以瞬间有100个请求通过）而漏桶算法的处理速度是恒定的。

### 计数器法

#### 思路

假设单位时间T内允许的请求为n个。开始时，设置一个计数器counter和当前时间t。当有请求时，如果与t的时间间隔在单位时间T内，counter加1，如果超过n，则拒绝服务；在n以内，则处理请求；如果时间间隔超过T，counter重置。

#### 问题

计数器法有临界问题。单位时间T为60秒，n为100。从0秒开始，如果用户在59秒时瞬间发送了100个请求，在第60秒又瞬间发送了100请求。在1秒内，瞬间发送了200个请求。

原因：计数不够平滑。

### 滑动窗口算法（rolling window）

#### 思路

对计数器算法进行改进，将单位时间T（如60秒）划分为60个单元格，每个单元格代表1秒的请求数。当59秒时处理100个请求，在60秒时又来100个请求，这时连续60个单元格内超过100，所以可以拒绝请求。

滑动窗口划分的单元格越多，滑动窗口越平滑，限流统计越精确。